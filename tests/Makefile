# Makefile for test execution
# tests/Makefile

.PHONY: help test test-unit test-integration test-api test-services test-schemas test-fast test-slow test-coverage clean install-test-deps

# ê¸°ë³¸ Python ëª…ë ¹ì–´
PYTHON := python
PIP := pip
PYTEST := pytest

# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬
PROJECT_DIR := ..
TEST_DIR := .

# ê¸°ë³¸ íƒ€ê²Ÿ
help: ## ë„ì›€ë§ í‘œì‹œ
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ì˜ˆì‹œ:"
	@echo "  make test              # ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make test-coverage     # ì»¤ë²„ë¦¬ì§€ì™€ í•¨ê»˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make test-fast         # ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰"

install-test-deps: ## í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
	@echo "ğŸ“¦ í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	$(PIP) install -r requirements-test.txt
	@echo "âœ… í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

test: ## ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸ§ª ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -v

test-unit: ## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "ğŸ”¬ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -m "unit" -v

test-integration: ## í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -m "integration" -v

test-api: ## API í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "ğŸŒ API í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/test_api_endpoints.py tests/test_integration.py::TestAPIIntegration -v

test-services: ## ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "âš™ï¸  ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/test_services.py -v

test-schemas: ## ìŠ¤í‚¤ë§ˆ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "ğŸ“‹ ìŠ¤í‚¤ë§ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/test_schemas.py -v

test-utils: ## ìœ í‹¸ë¦¬í‹° í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "ğŸ› ï¸  ìœ í‹¸ë¦¬í‹° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/test_utils.py -v

test-background: ## ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "â° ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/test_background_tasks.py -v

test-fast: ## ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (slow ë§ˆì»¤ ì œì™¸)
	@echo "âš¡ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -v -m "not slow"

test-slow: ## ëŠë¦° í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "ğŸŒ ëŠë¦° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -v -m "slow"

test-coverage: ## ì»¤ë²„ë¦¬ì§€ì™€ í•¨ê»˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸ“Š ì»¤ë²„ë¦¬ì§€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -v --cov=app --cov-report=html --cov-report=term-missing
	@echo "ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸: htmlcov/index.html"

test-coverage-xml: ## XML í˜•íƒœì˜ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„± (CIìš©)
	@echo "ğŸ“Š XML ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ --cov=app --cov-report=xml --cov-report=term

test-benchmark: ## ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸƒ ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ --benchmark-only -v

test-parallel: ## ë³‘ë ¬ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸš€ ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -v -n auto

test-verbose: ## ë§¤ìš° ìƒì„¸í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸ” ìƒì„¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ -vv -s

test-failed: ## ë§ˆì§€ë§‰ì— ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë§Œ ì¬ì‹¤í–‰
	@echo "âŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰ ì¤‘..."
	cd $(PROJECT_DIR) && $(PYTEST) tests/ --lf -v

test-watch: ## íŒŒì¼ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (pytest-watch í•„ìš”)
	@echo "ğŸ‘€ íŒŒì¼ ê°ì‹œ ëª¨ë“œë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
	cd $(PROJECT_DIR) && ptw tests/ app/

clean: ## í…ŒìŠ¤íŠ¸ ê´€ë ¨ ìºì‹œ ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬
	@echo "ğŸ§¹ í…ŒìŠ¤íŠ¸ ìºì‹œ ì •ë¦¬ ì¤‘..."
	find $(PROJECT_DIR) -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find $(PROJECT_DIR) -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find $(PROJECT_DIR) -name "*.pyc" -delete 2>/dev/null || true
	rm -rf $(PROJECT_DIR)/htmlcov/ 2>/dev/null || true
	rm -f $(PROJECT_DIR)/.coverage 2>/dev/null || true
	rm -f $(PROJECT_DIR)/coverage.xml 2>/dev/null || true
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

lint: ## ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
	@echo "ğŸ” ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ì¤‘..."
	cd $(PROJECT_DIR) && flake8 app/ tests/
	cd $(PROJECT_DIR) && black --check app/ tests/
	cd $(PROJECT_DIR) && isort --check-only app/ tests/

format: ## ì½”ë“œ í¬ë§·íŒ… ì ìš©
	@echo "âœ¨ ì½”ë“œ í¬ë§·íŒ… ì ìš© ì¤‘..."
	cd $(PROJECT_DIR) && black app/ tests/
	cd $(PROJECT_DIR) && isort app/ tests/

type-check: ## íƒ€ì… ê²€ì‚¬
	@echo "ğŸ” íƒ€ì… ê²€ì‚¬ ì¤‘..."
	cd $(PROJECT_DIR) && mypy app/

quality: lint type-check ## ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë¦°íŠ¸ + íƒ€ì… ê²€ì‚¬)

ci: install-test-deps test-coverage-xml lint type-check ## CI í™˜ê²½ì—ì„œ ì‹¤í–‰í•  ëª¨ë“  ê²€ì‚¬

# í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
setup-test-env: ## í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
	@echo "ğŸ› ï¸  í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • ì¤‘..."
	$(PIP) install -e $(PROJECT_DIR)
	make install-test-deps
	@echo "âœ… í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • ì™„ë£Œ"

# ê°œë°œ í™˜ê²½ì—ì„œ ìœ ìš©í•œ ì¡°í•© ëª…ë ¹ì–´
dev-test: test-fast lint ## ê°œë°œ ì¤‘ ë¹ ë¥¸ ê²€ì¦ (ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ + ë¦°íŠ¸)
	@echo "ğŸ¯ ê°œë°œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

full-check: test-coverage lint type-check ## ì „ì²´ ê²€ì‚¬ (ì»¤ë²„ë¦¬ì§€ + ë¦°íŠ¸ + íƒ€ì…)
	@echo "âœ… ì „ì²´ ê²€ì‚¬ ì™„ë£Œ"
